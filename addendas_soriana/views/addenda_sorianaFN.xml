<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="0">
        <template id="addenda_sorianaFN" name="Soriana Factura Normal codigo">
            <DSCargaRemisionProv>
                <!-- Variables de datos restantes -->
                <t t-set="sdato" t-value="'FaltaDato'"/>
                <!-- Datos del xml generado por el SAT -->
                <t t-set="xml" t-value="record._get_values_addenda()"/>
                <t t-set="format_float" t-value="xml.get('format_float')"/>
                <t t-set="format_string" t-value="xml.get('format_string')"/>
                <t t-set="tax_objected" t-value="xml.get('tax_objected')"/>
                <t t-set="currency_precision" t-value="xml.get('currency_precision')"/>
                <t t-set="serie" t-value="xml.get('serie_number')"/>
                <t t-set="folio" t-value="xml.get('folio_number')"/>
                <t t-set="subtotal" t-value="format_float(xml.get('total_price_subtotal_before_discount') if tax_objected == '02' else record.amount_total + xml.get('total_price_discount'), currency_precision)"/>
                <t t-set="descuentos" t-value="format_float(xml.get('total_price_discount'), currency_precision) if not record.currency_id.is_zero(xml.get('total_price_discount')) else None"/>
                <t t-set="total" t-value="format_float(record.amount_total, currency_precision)"/>

                <!-- Cantidad de productos -->
                <t t-set="cantidadent" t-value="0"/>
                <t t-set="cantcont" t-value="0"/>
                <t t-foreach="record.sale_order_id.order_line" t-as="rec">
                    <t t-set="cantidadent" t-value="cantidadent + rec.product_uom_qty"/>
                    <t t-set="cantcont" t-value="cantcont + 1"/>
                </t>

                <Remision Id="Remision1" RowOrder="0">
                    <Proveedor t-field="record.partner_shipping_id.shipping_number_provider"/>
                    <Remision t-esc="serie+'-'+str(folio)"/>
                    <Consecutivo>0</Consecutivo>
                    <t t-set="fechr" t-value="record.invoice_date" t-options="{&quot;format&quot;: &quot;yyyy-MM-dd&quot;}" />
                    <FechaRemision t-esc="str(fechr)+'T'+'00:00:00'"/>
                    <Tienda t-field="record.partner_shipping_id.shipping_number_store"/>
                    <TipoMoneda>1</TipoMoneda>
                    <TipoBulto>1</TipoBulto>
                    <EntregaMercancia t-field="record.partner_shipping_id.shipping_number_cedis"/>
                    <CumpleReqFiscales>true</CumpleReqFiscales>
                    <CantidadBultos t-esc="int(cantidadent)"/>
                    <Subtotal t-esc="subtotal"/>
                    <Descuentos>0</Descuentos>
                    <t t-set="tagiva" t-value="0"/>
                    <t t-set="tagieps" t-value="0"/>
                    <!-- FIXME: Revisar esta parte -->
                    <t t-set="tax_totals" t-value="json.loads(record.tax_totals_json)"/>
                    <t t-foreach="tax_totals['subtotals']" t-as="subtotal">
                        <t t-set="subtotal_to_show" t-value="subtotal['name']"/>
                        <t t-foreach="tax_totals['groups_by_subtotal'][subtotal_to_show]" t-as="amount_by_group">
                            <t t-set="is_ieps" t-value="request.env['account.tax.group'].browse(amount_by_group['tax_group_id']).is_ieps"/>
                            <t t-if="is_ieps == False">
                                <t t-set="tagiva" t-value="tagiva + amount_by_group['tax_group_amount']"/>
                            </t>
                            <t t-if="is_ieps == True">
                                <t t-set="tagieps" t-value="tagieps + amount_by_group['tax_group_amount']"/>
                            </t>
                        </t>
                    </t>
                    <IEPS t-esc="'%.2f'% tagieps"/>
                    <IVA t-esc="'%.2f'% float(tagiva)"/>
                    <OtrosImpuestos>0</OtrosImpuestos>
                    <Total t-esc="total"/>
                    <CantidadPedidos>1</CantidadPedidos>
                    <t t-set="pruebafecha" t-value="record.sale_order_id.commitment_date" t-options="{&quot;format&quot;: &quot;yyyy-MM-dd&quot;}"/>
                    <t t-if="pruebafecha">
                        <t t-set="pruebafecha" t-value="str(pruebafecha).split(' ')[0]"/>
                    </t>
                    <FechaEntregaMercancia t-esc="str(pruebafecha)+'T'+'00:00:00'"/>
                    <FolioNotaEntrada t-field="record.sale_order_id.entry_note_folio"/>
                </Remision>

                <Pedidos Id="Pedidos1" RowOrder="1">
                    <Proveedor t-field="record.partner_shipping_id.shipping_number_provider"/>
                    <Remision t-esc="serie+'-'+str(folio)"/>
                    <FolioPedido t-field="record.sale_order_id.number_order"/>
                    <Tienda t-field="record.partner_shipping_id.shipping_number_store"/>
                    <CantidadArticulos t-esc="int(cantcont)"/>
                </Pedidos>

                <!-- Articulos -->
                <t t-set="idrowart" t-value="0"/>
                <t t-set="porcentajeiva" t-value="0"/>
                <t t-set="porcentajeieps" t-value="0"/>
                <t t-set="valprecre" t-value="0" />
                <t t-foreach="record.sale_order_id.order_line" t-as="rec">
                    <t t-foreach="xml.get('invoice_line_vals_list')" t-as="line_vals">
                        <t t-set="line" t-value="line_vals['line']"/>
                        <t t-if="format_string(line.product_id.default_code) == rec.product_id.default_code">
                            <t t-set="valprecre" t-value="format_float(line_vals['gross_price_total_unit'] if tax_objected == '02' else (line.price_total + line_vals['price_discount']) / line.quantity, currency_precision)"/>
                        </t>
                    </t>
                    <t t-set="idrowart" t-value="idrowart + 1"/>
                    <Articulos t-att-Id="'Articulos'+str(idrowart)" t-att-RowOrder="str(idrowart)">
                        <Proveedor t-field="record.partner_shipping_id.shipping_number_provider"/>
                        <Remision t-esc="serie+'-'+str(folio)"/>
                        <FolioPedido t-field="record.sale_order_id.number_order"/>
                        <Tienda t-field="record.partner_shipping_id.shipping_number_store"/>
                        <Codigo t-esc="rec.product_id.barcode"/>
                        <CantidadUnidadCompra t-esc="'%.2f'% rec.product_uom_qty"/>
                        <CostoNetoUnidadCompra t-esc="'%.2f'% float(valprecre)"/>
                        <t t-foreach="rec.tax_id" t-as="tc">
                            <t t-if="tc.description[0:3] == 'IVA'">
                                <t t-set="porcentajeiva" t-value="tc.amount"/>
                            </t>
                            <t t-if="tc.is_ieps == True">
                                <t t-set="porcentajeieps" t-value="tc.amount"/>
                            </t>
                        </t>
                        <PorcentajeIEPS t-esc="0.00"/> <!-- FIXME: Revisar esta parte -->
                        <PorcentajeIVA t-esc="'%.2f'% porcentajeiva"/>
                    </Articulos>
                </t>
            </DSCargaRemisionProv>
        </template>
        <record id="addenda_sorianaFN" model="ir.ui.view">
            <field name="l10n_mx_edi_addenda_flag">True</field>
        </record>
    </data>
</odoo>